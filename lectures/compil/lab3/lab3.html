<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Lab 3 - Binder</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../pandoc.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header>
<h1 class="title">Lab 3 - Binder</h1>
</header>
<nav id="TOC">
<ul>
<li><a href="#setup">Setup</a></li>
<li><a href="#important-note">Important note</a></li>
<li><a href="#code-organization">Code organization</a></li>
<li><a href="#binding-variable-declarations">Binding Variable Declarations</a></li>
<li><a href="#binding-function-declarations">Binding Function Declarations</a></li>
<li><a href="#computing-the-depth-of-nodes-and-marking-escaping-declarations.">Computing the depth of nodes and marking escaping declarations.</a></li>
<li><a href="#breaks-and-loops">Breaks and loops</a></li>
</ul>
</nav>
<p>In this lab we will write a Binder for our Tiger compiler. The Binder is responsible for the following tasks:</p>
<ul>
<li>Wrapping the program inside a top-level <code>main</code> function;</li>
<li>Binding each identifier (function call or variable) to its declaration;</li>
<li>Decorating each identifier and each declaration with its depth;</li>
<li>Marking escaping declarations as such;</li>
<li>Decorating each break with its parent loop.</li>
</ul>
<p>The Binder must also raise an error when:</p>
<ul>
<li>An identifier is used but not declared;</li>
<li>An identifier is declared twice in the same scope;</li>
<li>A break is used outside of a loop or inside a Let declaration (except if enclosed by a loop).</li>
</ul>
<h2 id="setup">Setup</h2>
<p>Retrieve the lab code and commit it to your git with the following commands,</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1">$ <span class="fu">mkdir</span> lab3</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">$ <span class="bu">cd</span> lab3</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">$ <span class="fu">wget</span> -qO- www.sifflez.org/lectures/compil/lab3/dragon-tiger.tar.gz <span class="kw">|</span> <span class="fu">tar</span> zxv</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">$ <span class="fu">git</span> add -f dragon-tiger</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">$ <span class="fu">git</span> commit -m <span class="st">&quot;Import dragon-tiger for lab3&quot;</span> dragon-tiger</a></code></pre></div>
<p>The <code>-f</code> for <code>git add</code> is necessary to add the (usually ignored) <code>src/parser/libparser.a</code> which comes in the archive.</p>
<p>Now let us build the project,</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" data-line-number="1">$ <span class="bu">cd</span> dragon-tiger</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">$ <span class="ex">./configure</span> --with-llvm=/usr/lib/llvm-3.9</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">$ <span class="fu">make</span></a></code></pre></div>
<p>If everything worked as expected, you should be able to run the compiler driver <code>dtiger</code> as follows,</p>
<pre><code>$ src/driver/dtiger --help
Options:
  -h [ --help ]         describe arguments
  --dump-ast            dump the parsed AST
  -b [ --bind ]         run the binder on the parsed AST
  --trace-parser        enable parser traces
  --trace-lexer         enable lexer traces
  -v [ --verbose ]      be verbose
  --input-file arg      input Tiger file

$ echo &quot;a * b * c * d&quot; &gt; test.tig
$ src/driver/dtiger -v -b --dump-ast test.tig
function main(): int =
  (
    (((a*b)*c)*d);
    0
  )</code></pre>
<p>Ensure that you test thoroughly and commit each feature. Follow precisely the instructions, this lab is graded and machine corrected!</p>
<h2 id="important-note">Important note</h2>
<p>Some of you may not have completed the previous assignment. To this effect, the current archive contains a pre-built parser library (so as not to give you the full solution) and this lab may be done separately.</p>
<p>However, when you have completed the previous assignment, feel free to replace the <code>src/parser/</code> directory by a copy of the one from your previous assignment. This will be most satisfactory, as your code from the first step will be used also in the second step. Do not forget to add <code>parser</code> to the <code>SUBDIRS</code> variable in <code>src/Makefile.am</code> (it must be the <strong>first</strong> subdirectory there because it auto-generates files used in other subdirectories) and in <code>src/parser/Makefile</code> in <code>configure.ac</code>.</p>
<p>You might also want to propagate your evaluator code although this will not be needed.</p>
<h2 id="code-organization">Code organization</h2>
<p>The binder is called with the <code>-b</code> option. It is interesting to also add the options <code>-v --ast-dump</code> which provide a verbose AST dump. The verbose AST dump shows the depth and bound declaration for every decorated identifier. Because the Binder is not yet operational, the verbose AST dump does not yet show anything relevant.</p>
<p>A starting stub is provided for the Binder and it can be found at <code>src/ast/binder.[hh,cc]</code>.</p>
<ol class="example" type="1">
<li>Read carefully the provided code and ensure that you understand which method is wrapping the program inside a main function as shown below,</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" data-line-number="1">$ <span class="bu">echo</span> <span class="st">&quot;a * b * c * d&quot;</span> <span class="kw">|</span> <span class="ex">src/driver/dtiger</span> -v -b --dump-ast -</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw">function</span><span class="fu"> main()</span><span class="bu">:</span> int =</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  <span class="kw">(</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">    <span class="kw">((</span>(a*b)*c)*d);</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">    0</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">  )</a></code></pre></div>
<ol start="2" class="example" type="1">
<li><p>Why is it necessary to call the function <code>enter_primitive</code> in the Binderâ€™s constructor? Do you understand how they are not part of the tree, but they can be referenced by it?</p></li>
<li><p>Read and make sure you understand the methods <code>current_scope</code>, <code>push_scope</code>, <code>pop_scope</code>, <code>enter</code> andÂ <code>find</code>.</p></li>
</ol>
<h2 id="binding-variable-declarations">Binding Variable Declarations</h2>
<p>Your first task is binding each variable usage to its declaration.</p>
<p>For example, the expected output for the simple program</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode tiger"><code class="sourceCode tiger"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">let</span> <span class="kw">var</span> a <span class="op">:=</span> <span class="dv">0</span> <span class="kw">in</span> a <span class="kw">end</span></a></code></pre></div>
<p>is,</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" data-line-number="1">$ <span class="bu">echo</span> <span class="st">&quot;let var a := 0 in a end&quot;</span> <span class="kw">|</span> <span class="ex">src/driver/dtiger</span> -b --dump-ast -v -</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="kw">function</span><span class="fu"> main()</span><span class="bu">:</span> int =</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">  <span class="kw">(</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">    <span class="bu">let</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">      <span class="ex">var</span> a := 0</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">    <span class="kw">in</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7">      <span class="ex">a</span>/*decl:<span class="ex">1.5-7*/</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8">    <span class="ex">end</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9">    <span class="ex">0</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10">  <span class="kw">)</span></a></code></pre></div>
<p>As you can see, the usage of <code>a</code> indicates that it refers to the variable declared at line 1 columns 5-7 (location points to the var keyword).</p>
<p>Currently, your binder does nothing.</p>
<ol start="4" class="example" type="1">
<li><p>Add support for binding each variable usage to its declaration. To bind a variable identifier <code>id</code> to its declaration <code>decl</code> you shall use the method <code>id.set_decl(decl);</code>. Your binder must adhere to the <em>scoping rules</em> of Tiger.</p></li>
<li><p>Ensure you detect the following illegal cases:</p></li>
</ol>
<ul>
<li><p>An identifier is used but not declared</p></li>
<li><p>An identifier is declared twice in the same scope</p></li>
</ul>
<p>In those illegal cases, you must raise a fatal error with the <code>utils::error()</code> function.</p>
<p>Ensure that your Binder works on complex scenarios with hiding or escaping, including with loop indices who need their own scope and cannot be assigned to.</p>
<p>Because function arguments are handled as <code>VarDecl</code> nodes in the AST, they should also be properly bound by your code.</p>
<h2 id="binding-function-declarations">Binding Function Declarations</h2>
<ol start="6" class="example" type="1">
<li>Add support for binding each function call to its declaration. Remember that in Tiger, a set of consecutive function declarations can be mutually referencing.</li>
</ol>
<p>For example the following Tiger program,</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode tiger"><code class="sourceCode tiger"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">let</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">  <span class="kw">function</span> even(n <span class="op">:</span> <span class="dt">int</span>) <span class="op">:</span> <span class="dt">int</span> <span class="op">=</span> <span class="cf">if</span> n <span class="op">=</span> <span class="dv">0</span> <span class="cf">then</span> <span class="dv">1</span> <span class="cf">else</span> odd(n<span class="op">-</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">  <span class="kw">function</span> odd(n <span class="op">:</span> <span class="dt">int</span>) <span class="op">:</span> <span class="dt">int</span> <span class="op">=</span> <span class="cf">if</span> n <span class="op">=</span> <span class="dv">0</span> <span class="cf">then</span> <span class="dv">0</span> <span class="cf">else</span> even(n<span class="op">-</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="kw">in</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">  <span class="fu">print_int</span>(odd(<span class="dv">5</span>))</a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="kw">end</span></a></code></pre></div>
<p>will produce the following verbose AST dump,</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode tiger"><code class="sourceCode tiger"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">function</span> main()<span class="op">:</span> <span class="dt">int</span> <span class="op">=</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  (</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">    <span class="kw">let</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4">      <span class="kw">function</span> even<span class="co">/*main.even*/</span>(n<span class="op">:</span> <span class="dt">int</span>) <span class="op">=</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">        <span class="cf">if</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6">          (n<span class="co">/*decl:2.17*/</span><span class="op">=</span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">         <span class="cf">then</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8">          <span class="dv">1</span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9">         <span class="cf">else</span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10">          odd<span class="co">/*decl:3.3-10*/</span>((n<span class="co">/*decl:2.17*/</span><span class="op">-</span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb8-11" data-line-number="11">      <span class="kw">function</span> odd<span class="co">/*main.odd*/</span>(n<span class="op">:</span> <span class="dt">int</span>) <span class="op">=</span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12">        <span class="cf">if</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13">          (n<span class="co">/*decl:3.16*/</span><span class="op">=</span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb8-14" data-line-number="14">         <span class="cf">then</span></a>
<a class="sourceLine" id="cb8-15" data-line-number="15">          <span class="dv">0</span></a>
<a class="sourceLine" id="cb8-16" data-line-number="16">         <span class="cf">else</span></a>
<a class="sourceLine" id="cb8-17" data-line-number="17">          even<span class="co">/*decl:2.3-10*/</span>((n<span class="co">/*decl:3.16*/</span><span class="op">-</span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb8-18" data-line-number="18">    <span class="kw">in</span></a>
<a class="sourceLine" id="cb8-19" data-line-number="19">      <span class="fu">print_int</span><span class="co">/*decl:&lt;none&gt;:0.0*/</span>(odd<span class="co">/*decl:3.3-10*/</span>(<span class="dv">5</span>))</a>
<a class="sourceLine" id="cb8-20" data-line-number="20">    <span class="kw">end</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-21" data-line-number="21">    <span class="dv">0</span></a>
<a class="sourceLine" id="cb8-22" data-line-number="22">  )</a></code></pre></div>
<p>Declarations nodes for the primitive functions (such as <code>print_int</code>) have already been inserted in the top-level scope. They require no special handling. In the verbose AST dump, they are marked with a no-location <code>/*decl:&lt;none&gt;:0.0*/</code>.</p>
<ol start="7" class="example" type="1">
<li>Make sure that the error handling code also works for function calls and declarations.</li>
</ol>
<p>Remember to test your implementation in corner cases and complex scenarios.</p>
<h2 id="computing-the-depth-of-nodes-and-marking-escaping-declarations.">Computing the depth of nodes and marking escaping declarations.</h2>
<p>To handle escapes later on, we need to compute the depth of variable, function declarations, identifiers and function calls.</p>
<p>The depth is the number of nesting function levels. For example a top-level declaration has depth 0. A declaration that lives inside a top-level function has depth 1. A declaration inside a doubly nested function has depth 2.</p>
<ol start="8" class="example" type="1">
<li><p>Implement depth computation and decoration in your Binder. To decorate a node <code>n</code> with its depth <code>d</code>, you shall use <code>n.set_depth(d);</code>.</p></li>
<li><p>All variables declarations that are accessed from a different depth should be marked as <em>escaping</em>. To mark a declaration <code>d</code> as escaping, you shall use <code>d.set_escapes()</code>.</p></li>
</ol>
<p>The AST verbose dump shows non-null depth differences between a declaration and its use; it also shows escaping variables withÂ <code>/*e*/</code>.</p>
<p>For example, the following Tiger program,</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode tiger"><code class="sourceCode tiger"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">let</span> <span class="kw">var</span> a <span class="op">:=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">    <span class="kw">function</span> f() <span class="op">:</span> <span class="dt">int</span> <span class="op">=</span> a</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="kw">in</span> f() <span class="kw">end</span></a></code></pre></div>
<p>should produce the following verbose dump,</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode tiger"><code class="sourceCode tiger"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">function</span> main()<span class="op">:</span> <span class="dt">int</span> <span class="op">=</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">  (</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">    <span class="kw">let</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4">      <span class="kw">var</span> a<span class="co">/*e*/</span> <span class="op">:=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5">      <span class="kw">function</span> f<span class="co">/*main.f*/</span>()<span class="op">:</span> <span class="dt">int</span> <span class="op">=</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6">        a<span class="co">/*decl:1.5-7 depth_diff:1*/</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">    <span class="kw">in</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8">      f<span class="co">/*decl:2.5-12*/</span>()</a>
<a class="sourceLine" id="cb10-9" data-line-number="9">    <span class="kw">end</span><span class="op">;</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10">    <span class="dv">0</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11">  )</a></code></pre></div>
<p>As you can see the depth difference between <code>a</code> and its declaration is one; therefore the declaration of <code>a</code> escapes.</p>
<h2 id="breaks-and-loops">Breaks and loops</h2>
<p>Each <code>break</code> statement should be decorated with its parent loop. To do so you shall use the function <code>break.set_loop(loop)</code>; where <code>loop</code> is of class <code>Loop</code> (either a <code>ForLoop</code> or a <code>WhileLoop</code>).</p>
<ol start="10" class="example" type="1">
<li><p>Decorate each break with its parent loop. To achieve this you may use a class member variable to record the visited loops.</p></li>
<li><p>Ensure that you raise an error if a break is used outside of a loop or directly inside the declaration part of a Let block.</p></li>
</ol>
<p>For example, the tiger program <code>while(1) do break</code> emits the following verbose AST dump,</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode tiger"><code class="sourceCode tiger"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">function</span> main()<span class="op">:</span> <span class="dt">int</span> <span class="op">=</span> </a>
<a class="sourceLine" id="cb11-2" data-line-number="2">  (</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">    <span class="cf">while</span> (</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">      <span class="dv">1</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5">    ) <span class="cf">do</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6">      <span class="cf">break</span><span class="co">/*loop:1.1-5*/</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7">    <span class="dv">0</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8">  )</a></code></pre></div>
</body>
</html>
