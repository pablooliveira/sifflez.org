<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Lab 2 - Tiger Calculator</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../pandoc.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header>
<h1 class="title">Lab 2 - Tiger Calculator</h1>
</header>
<nav id="TOC">
<ul>
<li><a href="#import-the-example-code">Import the example code</a></li>
<li><a href="#look-around">Look around</a></li>
<li><a href="#the-ast-nodes">The AST nodes</a></li>
<li><a href="#building-the-project">Building the project</a></li>
<li><a href="#supporting-integers">Supporting integers</a></li>
<li><a href="#a-note-on-symbols">A note on symbols</a></li>
<li><a href="#adding-support-for-more-binary-operators-and-adding-precedence-rules">Adding support for more binary operators and adding precedence rules</a></li>
<li><a href="#adding-support-for-the-boolean-or-operator">Adding support for the boolean OR operator</a></li>
<li><a href="#adding-support-for-if-then-else-constructs">Adding support for <code>if then else</code> constructs</a></li>
<li><a href="#implementing-an-ast-evaluator-for-simple-tiger-int-expressions">Implementing an AST evaluator for simple Tiger int expressions</a></li>
</ul>
</nav>
<p>In this lab we will study and improve a Lexer and Parser for the Tiger language. We will also write an AST Iterator that evaluates simple integer Tiger expressions.</p>
<p>We will start from a compiler skeleton built by your teachers.</p>
<h2 id="import-the-example-code">Import the example code</h2>
<p>Retrieve the lab code and commit it to your git with the following commands in the subdirectory <code>lab2</code> (because this is the second week of the class) at the root of your git repository.</p>
<p>Execute the following commands at the top of your repository:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1">$ <span class="fu">mkdir</span> lab2</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">$ <span class="bu">cd</span> lab2</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">$ <span class="fu">wget</span> -qO- www.sifflez.org/lectures/compil/lab2/dragon-tiger.tar.gz <span class="kw">|</span> <span class="fu">tar</span> zxv</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">$ <span class="fu">git</span> add dragon-tiger</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">$ <span class="fu">git</span> commit -m <span class="st">&quot;Import dragon-tiger for lab2&quot;</span> dragon-tiger</a></code></pre></div>
<h2 id="look-around">Look around</h2>
<p>The sources in <code>dragon-tiger</code> are organized this way:</p>
<ul>
<li><code>src/ast</code> contains the definition of the tree. In <code>nodes.hh</code> you can see all the nodes declaration. You should not alter this file.</li>
<li><code>src/parser</code> contains the lexer (<code>tiger_lexer.ll</code>) for use with the <code>lex</code>/<code>flex</code> lexer generator, and the parser (<code>tiger_parser.yy</code>) for the <code>yacc</code>/<code>bison</code> parser generator.</li>
<li><code>src/driver</code> contains the main program in <code>driver.cc</code>.</li>
<li><code>src/utils</code> contains some utility classes to deal with errors.</li>
</ul>
<p>If needed, <code>flex</code> documentation is <a href="https://westes.github.io/flex/manual/">located here</a> and <code>bison</code> documentation can be <a href="https://www.gnu.org/software/bison/manual/">found here</a>, but the existing code should be self-explanatory and reading it should be enough to implement the requested features.</p>
<h2 id="the-ast-nodes">The AST nodes</h2>
<p>The AST contains nodes derived from the <code>Node</code> class. There are two kind of nodes, which derive directly from this top-level <code>Node</code> class: <code>Expr</code> represents any form of Tiger expressions, while <code>Decl</code> represents declarations.</p>
<p>The <code>nodes.hh</code> also contains structures that help use the <a href="https://en.wikipedia.org/wiki/Visitor_pattern">visitor pattern</a>. You should read and understand it, as the last item of this lab will need to use it.</p>
<h2 id="building-the-project">Building the project</h2>
<p>From within the <code>dragon-tiger</code> repository, run:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" data-line-number="1">$ <span class="ex">./configure</span> --with-llvm=/usr/lib/llvm-3.9</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">$ <span class="fu">make</span></a></code></pre></div>
<p>If everything worked as expected, you should be able to run the compiler driver <code>dtiger</code> as follows,</p>
<p>Note: <code>--with-llvm</code> is only needed on the lab room’s computers because the development files are installed in a non-standard place. If you use your own computer with an up-to-date llvm development package, you probably won’t need to tell <code>configure</code> where <code>llvm-config</code> and friends are.</p>
<pre><code>$ src/driver/dtiger --help
Options:
  -h [ --help ]         describe arguments
  --dump-ast            dump the parsed AST
  --trace-parser        enable parser traces
  --trace-lexer         enable lexer traces
  -v [ --verbose ]      be verbose
  --input-file arg      input Tiger file

$ echo &quot;a * b * c * d&quot; &gt; test.tig
$ src/driver/dtiger --dump-ast test.tig
(a*(b*(c*d)))</code></pre>
<p>You can use <code>-</code> as a file name to read the Tiger code from the standard input without using an intermediate file:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" data-line-number="1">$ <span class="bu">echo</span> <span class="st">&quot;a * b&quot;</span> <span class="kw">|</span> <span class="ex">src/driver/dtiger</span> --dump-ast -</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw">(</span><span class="ex">a*b</span><span class="kw">)</span></a></code></pre></div>
<p>As you can see a simple lexer, parser, and AST dumper (printer) are already implemented.</p>
<p>In the following lab you will add new features to <code>dtiger</code>, ensure that you test thoroughly and commit each feature. Follow precisely the instructions, this lab is graded and machine corrected!</p>
<p>Remember: you should never have to modify <code>ast/nodes.hh</code> during this lab.</p>
<h2 id="supporting-integers">Supporting integers</h2>
<p>Your first task is implementing support for integer literals.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" data-line-number="1">$ <span class="bu">echo</span> <span class="st">&quot;1*2&quot;</span> <span class="kw">|</span> <span class="ex">src/driver/dtiger</span> --dump-ast -</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="ex">1.1</span>: invalid character</a></code></pre></div>
<p>As you can see in the above example, currently, the lexer and parser do not recognize integers. To debug the parser and lexer you can activate trace modes:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" data-line-number="1">$ <span class="bu">echo</span> <span class="st">&quot;1*2&quot;</span> <span class="kw">|</span> <span class="ex">src/driver/dtiger</span> --dump-ast --trace-lexer -</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="ex">--</span>(end of buffer or a NUL)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="ex">--accepting</span> rule at line 122 (<span class="st">&quot;1&quot;</span>)</a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="ex">1.1</span>: invalid character</a></code></pre></div>
<p>(line numbers may vary)</p>
<p>Can you understand what is happening? Look for the string “invalid character” in the lexer file <code>src/parser/tiger_lexer.ll</code>. It looks like someone forgot to add a rule to recognize integers.</p>
<ol class="example" type="1">
<li>First add an <code>INT</code> token in the parser. Look at <code>src/parser/tiger_parser.yy</code> after the comment starting with “Define tokens”. The type of the token should be <code>int</code>, its name <code>INT</code>, and its comment <code>integer</code>.</li>
<li>Add support for recognizing integers in the lexer. You should look at how this is implemented for <code>ID</code> tokens. First, add a rule for a regular expression matching integers. No need to worry about the minus sign; it is already handled in the parser. In the <code>flex</code> action for integers, use the function <code>strtol</code> to convert the matched text (<code>yytext</code>) to an integer and emit an <code>INT</code> token. You should ensure that the parsed integer is in the range of legal Tiger integers (the constant <code>TIGER_INT_MAX</code> has been defined for you), and signal a correctly placed error using <code>utils::error</code> if not.</li>
<li>Ensure that you reject numbers with leading 0 as the Tiger language forbids them (but you must accept 0 of course).</li>
</ol>
<p>Now the lexer should recognize integers,</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" data-line-number="1">$ <span class="bu">echo</span> <span class="st">&quot;1*2&quot;</span> <span class="kw">|</span> <span class="ex">src/driver/dtiger</span> --trace-lexer --trace-parser --dump-ast -</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="ex">Starting</span> parse</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="ex">Entering</span> state 0</a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="ex">Reading</span> a token: --(end of buffer or a NUL)</a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="ex">--accepting</span> rule at line 87 (<span class="st">&quot;1&quot;</span>)</a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="ex">Next</span> token is token <span class="st">&quot;int&quot;</span> (1.1: )</a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="ex">1.1</span>: syntax error, unexpected int</a></code></pre></div>
<p>but the parser still complains because integers are not valid expressions.</p>
<ol start="4" class="example" type="1">
<li>Add support for integer expressions in the parser. You should add a new rule that matches an INT token and returns an AST Node of type <code>IntegerLiteral</code>. For this, you need to perform three steps: add an <code>intExpr</code> rule doing the matching and returning a new <code>IntegerLiteral</code> node, declare the type of <code>intExpr</code> as being <code>Expr *</code> (see how this is done for <code>stringExpr</code> for example), and add a case to the <code>expr</code> rule to make it accept <code>intExpr</code> everywhere an <code>expr</code> is acceptable (as it does for <code>stringExpr</code> for example).</li>
</ol>
<p>When you finish this section, the Tiger program <code>1*2</code> should be properly parsed!</p>
<h2 id="a-note-on-symbols">A note on symbols</h2>
<p>Throughout the lexer and parser files, you may have noticed that strings are represented using the <code>Symbol</code> type. This type, which is defined in <code>src/utils/symbols.hh</code>, allows to detect when similar objects are used (here we use it for strings and identifiers) and return a shared reference for similar objects.</p>
<p>For example, if the <code>foobar_identifier_123</code> identifier is used 10,000 times in your Tiger source code, the string will be present only once in memory and the AST will contain 10,000 identical references to it instead of pointing onto 10,000 different copies.</p>
<h2 id="adding-support-for-more-binary-operators-and-adding-precedence-rules">Adding support for more binary operators and adding precedence rules</h2>
<p>Currently the following expression <code>1*2+3</code> is parsed as <code>(1*(2+3))</code>. This is clearly incorrect, because the <code>*</code> is more binding than the <code>+</code>.</p>
<p>If you look at the file <code>src/parser/bison-report.txt</code> you will find many shift/reduce and reduce/reduce conflicts. Such as,</p>
<pre><code>State 25

   20 negExpr: &quot;-&quot; expr .
   21 opExpr: expr . &quot;+&quot; expr
   22       | expr . &quot;-&quot; expr
   23       | expr . &quot;*&quot; expr
   24       | expr . &quot;/&quot; expr
   25       | expr . &quot;=&quot; expr
   26       | expr . &quot;&lt;&gt;&quot; expr
   27       | expr . &quot;&lt;&quot; expr
   28       | expr . &quot;&gt;&quot; expr
   29       | expr . &quot;&lt;=&quot; expr
   30       | expr . &quot;&gt;=&quot; expr
   31       | expr . &quot;&amp;&quot; expr

    &quot;+&quot;   shift, and go to state 32
    &quot;-&quot;   shift, and go to state 33
[…]

    &quot;+&quot;       [reduce using rule 20 (negExpr)]
    &quot;-&quot;       [reduce using rule 20 (negExpr)]
[…]</code></pre>
<p>Here the parser is parsing the following kind of construct <code>-4+5</code> and got confused. Should it be parsed as <code>-(4+5)</code> (incorrect) or <code>(-4)+5</code> (correct)? The parser does not contain the necessary information yet.</p>
<p>How to read this report? The reading cursor, depicted by a dot (<code>.</code>) is currently just before the <code>+</code> operator: it parsed a minus sign <code>-</code>, an expression <code>4</code>, and does not know what to do when it encounters a <code>+</code> sign. It hesitates between:</p>
<ul>
<li><p><strong>reducing</strong> <code>(-4)</code> right now which will utimately produce the following (correct) AST <code>((-4)+5)</code></p></li>
<li><p><strong>shifting</strong> which will ultimately produce the following (incorrect) AST <code>(-(4+5))</code></p></li>
</ul>
<p>The default choice in Bison is to shift. Therefore here, the parser will produce the second incorrect AST.</p>
<p>To fix these ambiguities one must declare precedence rules for the operators and some keywords. If you look for “Declare precedence rules” in <code>tiger_parser.yy</code> you will find at this stage</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode yacc"><code class="sourceCode yacc"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">%nonassoc</span> FUNCTION VAR TYPE DO OF ASSIGN;</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="kw">%left</span> UMINUS;</a></code></pre></div>
<p>It means that <code>FUNCTION</code>, <code>VAR</code>, and so on are not associative. It also means that the unary minus (denoted by <code>UMINUS</code>) is associative left (not that it matters for an unary operator), and that it has a higher precedence than <code>FUNCTION</code>, <code>VAR</code>, and so on, because it is declared after them.</p>
<p>As an example, <code>+</code> should be associative left, and have a precedence lower (“be declared before”) than the unary minus, because you want <code>-4+5</code> to be parsed as <code>(-4)+5</code>, not as <code>-(4+5)</code>.</p>
<ol start="5" class="example" type="1">
<li>Add precedence rules until you fix all the shift/reduce and reduce/reduce conflicts in the parser. Check that you correctly parse arithmetic expressions such as <code>1+2*3</code>, <code>5-2-1</code> or <code>-4+5</code>.</li>
</ol>
<h2 id="adding-support-for-the-boolean-or-operator">Adding support for the boolean OR operator</h2>
<p>To simplify subsequent phases in the compiler, boolean operators are translated to an <code>IfThenElse</code> AST node. Indeed, due to Tiger’s lazy evaluation of boolean operators, <code>a &amp; b</code> is semantically equivalent to the following code,</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode tiger"><code class="sourceCode tiger"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="cf">if</span> (a) <span class="cf">then</span> (<span class="cf">if</span> (b) <span class="cf">then</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">0</span>) <span class="cf">else</span> <span class="dv">0</span> </a></code></pre></div>
<ol start="6" class="example" type="1">
<li><p>Add support for <code>|</code> (OR) boolean operator in the parser. Do not produce a <code>BinaryOperator</code> node, use an <code>IfThenElse</code> node with a construction similar to the one used by the <code>&amp;</code> (AND) operator.</p></li>
<li><p>Test that your compiler recognizes the new constructs.</p></li>
</ol>
<h2 id="adding-support-for-if-then-else-constructs">Adding support for <code>if then else</code> constructs</h2>
<ol start="8" class="example" type="1">
<li>Add support for <code>if then else</code> and <code>if then</code> constructs to the lexer and parser.</li>
</ol>
<p>To simplify subsequent phases in the compiler, when you find a naked</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode tiger"><code class="sourceCode tiger"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="cf">if</span> condition <span class="cf">then</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">    body</a></code></pre></div>
<p>block replace it by the following equivalent construct,</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode tiger"><code class="sourceCode tiger"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="cf">if</span> condition <span class="cf">then</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2">    body</a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="cf">else</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4">    ()</a></code></pre></div>
<p>The <code>()</code> corresponds to a <code>Sequence</code> AST node with an empty expression vector.</p>
<p>Be careful to fix any shift/reduce or reduce/reduce conflicts you may introduce. Do not forget to declare the type of the new expression you created and to add it to the list of acceptable expressions.</p>
<h2 id="implementing-an-ast-evaluator-for-simple-tiger-int-expressions">Implementing an AST evaluator for simple Tiger int expressions</h2>
<p>Now that your parser and lexer are complete, we are going to add a new AST iterator that evaluates them to build a simple Tiger calculator.</p>
<p>The AST evaluator should support evaluating the following AST nodes:</p>
<ul>
<li><p>An <code>IntegerLiteral</code> evaluates to its integer value.</p></li>
<li><p><code>A BinaryOperator</code> evaluates to the result between the two operands. For boolean operators <code>1</code> is true and <code>0</code> is false.</p></li>
<li><p>A <code>Sequence</code> evaluates all its sub-expressions, and evaluates to the value of its last sub-expression. An empty sequence should raise an error and terminate the evaluation.</p></li>
<li><p>A <code>IfThenElse</code> block evaluates to the value of the <code>then</code> or <code>else</code> branch depending if the condition is true or false. The other branch is not evaluated at all.</p></li>
</ul>
<p><strong>All the other nodes should raise an error when evaluated.</strong></p>
<p>The evaluator can be called with the <code>-e</code> (and <code>--eval</code>) command line option. It should work as follows,</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb13-1" data-line-number="1">$ <span class="bu">echo</span> <span class="st">&quot;2*3&quot;</span> <span class="kw">|</span> <span class="ex">src/driver/dtiger</span> -e -</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="ex">6</span></a></code></pre></div>
<p>Please ensure that your implementation works exactly as above so that this work can be graded automatically.</p>
<p>When using both <code>-e</code> and <code>--ast-dump</code>, an error should be triggered.</p>
<p>Errors should be raised with the <code>util/errors.hh</code> functions and should be fatal.</p>
<p>The evaluator should reside in the <code>src/ast</code> directory in the <code>ast</code> namespace and extend the class <code>ConstASTIntVisitor</code>.</p>
<ol start="9" class="example" type="1">
<li>Implement the Evaluator as described above.</li>
</ol>
</body>
</html>
